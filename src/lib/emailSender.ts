// /lib/emailSender.ts

import * as nodemailer from 'nodemailer';

// 1. Create a Transporter (the connection to Mailtrap)
// The transporter is configured once and reused for all emails.
// It securely reads the credentials from your .env.local file.
const transporter = nodemailer.createTransport({
    host: process.env.MAILTRAP_HOST,
    // Port 587 uses STARTTLS, port 2525 is alternative, port 465 uses SSL/TLS
    port: parseInt(process.env.MAILTRAP_PORT || '587'),
    secure: false, // false for STARTTLS (587/2525), true for SSL/TLS (465)
    auth: {
        user: process.env.MAILTRAP_USER,
        pass: process.env.MAILTRAP_PASS,
    },
});

/**
 * Sends a custom email containing the secure invite link to the approved agent.
 * @param recipientEmail The agent's email address.
 * @param inviteLink The secure action link generated by supabaseAdmin.auth.admin.generateLink().
 */
export async function sendInviteLinkEmail(recipientEmail: string, inviteLink: string) {

    // 2. Define the email content
    const mailOptions = {
        // Must be a valid email address (e.g., matching the Sender Email in Supabase Auth settings)
        from: 'no-reply@arkalliance.com',
        to: recipientEmail,
        subject: 'ðŸŽ‰ ArkAlliance Account Approved: Set Your Password',
        html: `
            <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                <h1>Welcome to ArkAlliance!</h1>
                <p>Your account has been **approved** by our administration team. You can now set your permanent password and log in to the portal.</p>
                
                <p>Click the secure link below to proceed:</p>
                
                <a href="${inviteLink}" 
                   style="display: inline-block; background-color: #007bff; color: white; padding: 12px 25px; text-decoration: none; border-radius: 6px; font-weight: bold;">
                    Set Your Password & Login
                </a>
                
                <p style="margin-top: 20px;">The link is **single-use** and valid for a short time. If you have trouble, please contact support.</p>
            </div>
        `,
    };

    // 3. Send the email
    try {
        const info = await transporter.sendMail(mailOptions);
        console.log(`Invite email sent successfully to ${recipientEmail}. Message ID: ${info.messageId}`);
        return { success: true, messageId: info.messageId };
    } catch (error: any) {
        console.error(`Error sending email to ${recipientEmail}:`, error);
        // Return a clear failure signal for the calling Admin action
        return { success: false, error: error.message };
    }
}